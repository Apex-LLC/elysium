<div class="table-header-row">
  <div class='table-row-item meter-item'>
    <div class="table-cell reference">Meter</div>
    <div class="table-cell allocation">Usage</div>
    <div class="table-cell amount">Amount Due</div>
  </div>
</div>
<div class="table h-100">
  <% 
    invoice_usage = number_with_precision(@invoice.usage, precision: 2, delimiter:',')
    total_due = number_with_delimiter(number_to_currency(@invoice.total), delimiter:',')
    tax_and_fees_due = number_with_delimiter(number_to_currency(@invoice.fees), delimiter:',')

    @invoice.billable_meters.each do |meter|
      if (meter.description?) 
        meter_reference = meter.description 
      else 
        meter_reference = meter.meter.reference 
      end 

      meter_usage = number_with_precision(meter.get_usage(@invoice.start_date,@invoice.end_date), precision:2, delimiter:',').to_f
      if (meter.is_peak_demand_meter?)
        meter_amount_due = number_to_currency(meter.get_amount_due_peak_demand(@invoice.start_date,@invoice.end_date))
      else
        meter_amount_due = number_to_currency(meter.get_amount_due_from_usage(meter_usage))
      end
      %>
      <div class="table-row">
        <div class='table-row-item meter-item' data-href=''>
          <div class="table-cell reference">
            <%= meter_reference %>                  
          </div>
          <div class="table-cell allocation"><%= meter_usage %> kWh</div>
          <div class="table-cell amount"><%= meter_amount_due %></div>
        </div>
      </div>
    <% end %>

    <% current_account.admin_costs.each do |cost| 
      rate = ""
      total = "0.0"
      if (cost.percent)
        rate = cost.percent.to_s + "%"
        total = number_to_currency(@invoice.amount * (cost.percent/100.0))
      else
        rate = " - "
        total = number_to_currency(cost.flat_fee.to_s)
      end
      %>
      <div class="table-row">
        <div class='table-row-item meter-item' data-href=''>
          <div class="table-cell reference"><%= cost.label %></div>
          <div class="table-cell allocation"><%= rate %></div>
          <div class="table-cell amount"><%= total %></div>
        </div>
      </div>
    <% end %>

    <div class="table-row">
      <div class='table-row-item meter-item expanding-row' data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
        <div class="table-cell reference">Taxes and Fees</div>
        <div class="table-cell allocation"> - </div>
        <div class="table-cell amount"><%= tax_and_fees_due %></div>
      </div>
      <div class='table-row-item-description meter-item collapse' id="collapseExample" >
         <div class="table-cell reference font-italic">2.9% Processing Fee</div>
        <div class="table-cell allocation">   </div>
        <div class="table-cell amount"><%= tax_and_fees_due %></div>
      </div>
    </div>
    <div class="table-row">
      <div class='table-totals'>
        <div class="table-cell reference">Totals</div>
        <div class="table-cell allocation"><%= invoice_usage %> kWh</div>
        <div class="table-cell total"><%= total_due %></div>
      </div>
    </div>
</div>